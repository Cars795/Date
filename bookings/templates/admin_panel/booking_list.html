{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reservas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; font-size: 0.95rem; }
    .page-container { max-width: 1250px; margin: 0 auto; padding: 1rem 2rem 3rem; position: relative; }

    .sticky-topbar {
      position: sticky; top: 0; z-index: 1030;
      background: #f8f9fa; border-bottom: 1px solid #dee2e6;
      padding: 1rem 0 0.75rem;
    }

    .kpi-card { text-align: center; flex: 1; border-radius: 0.75rem; }
    .kpi-card h5 { margin: 0; font-weight: 600; }
    .kpi-card small { color: #6c757d; }

    .table-hover tbody tr:hover { background-color: #f6faff; transition: 0.2s; }

    .filter-input {
      width: 100%; border: 1px solid #dee2e6; border-radius: 4px;
      padding: 4px 26px 4px 8px; font-size: 0.85rem;
      transition: all 0.2s ease; background-color: #fff;
    }
    .filter-input.active-filter {
      border-color: #0d6efd; box-shadow: 0 0 0 2px rgba(13,110,253,0.25);
      background: #e8f0fe;
    }

    .filter-wrapper { position: relative; }
    .clear-btn {
      position: absolute; right: 8px; top: 50%;
      transform: translateY(-50%); cursor: pointer;
      font-size: 0.85rem; color: #999; display: none;
    }
    .clear-btn:hover { color: #dc3545; }

    .filter-status { font-size: 0.85rem; color: #6c757d; }
    .filter-status strong { color: #0d6efd; }

    .grid-toolbar {
      display: flex; justify-content: space-between; align-items: center;
      background: #f1f3f5; border-radius: 6px;
      padding: 0.5rem 0.75rem; margin-bottom: 0.25rem;
    }

    .pagination { justify-content: center; margin-top: 1rem; }
    .page-link { color: #0d6efd; }
    .page-item.active .page-link { background-color: #0d6efd; border-color: #0d6efd; }

    /* --- Floating bar --- */
    .floating-tools {
      position: fixed; right: 24px; bottom: 80px;
      display: flex; flex-direction: column; gap: 0.5rem; z-index: 2000;
    }
    .floating-tools button {
      border: none; background: #0d6efd; color: white;
      border-radius: 50%; width: 42px; height: 42px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
      transition: transform 0.2s ease, background 0.2s;
      position: relative;
    }
    .floating-tools button:hover { background: #084298; transform: scale(1.1); }
    @media (max-width: 768px) { .floating-tools { display: none; } }
    .floating-tools button::after {
      content: attr(data-title);
      position: absolute; right: 50px; top: 50%; transform: translateY(-50%);
      background: rgba(0,0,0,0.75); color: white; font-size: 0.75rem;
      padding: 3px 8px; border-radius: 4px; opacity: 0; transition: opacity 0.2s;
      white-space: nowrap;
    }
    .floating-tools button:hover::after { opacity: 1; }

    /* --- Popup --- */
    #popupSummary {
      position: fixed; right: 20px; bottom: 140px;
      background: #fff; border: 1px solid #dee2e6; border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 1rem 1.25rem; display: none; z-index: 2050;
      min-width: 280px; animation: fadeIn 0.3s ease;
    }
    #popupSummary h6 { font-weight: 600; margin-bottom: 0.5rem; }
    #popupSummary.success { border-left: 4px solid #28a745; }
    #popupSummary.warning { border-left: 4px solid #ffc107; }
    #popupSummary.error { border-left: 4px solid #dc3545; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="page-container">

    <!-- Header -->
    <div class="sticky-topbar">
      <div class="mb-3">
        <a href="{% url 'admin_panel:dashboard' %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left"></i> Panel
        </a>
      </div>

      <h3 class="text-primary fw-semibold mb-4">Reservas</h3>

      <div class="d-flex justify-content-center mb-4">
        <form method="get" class="d-flex align-items-center" style="max-width: 420px; width:100%;">
          <input type="text" name="q" value="{{ query }}" class="form-control form-control-sm me-2" placeholder="Buscar cliente, evento o contacto...">
          <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-search"></i></button>
          {% if query %}
          <a href="{% url 'admin_panel:booking_list' %}" class="btn btn-sm btn-outline-secondary ms-2"><i class="bi bi-x-circle"></i></a>
          {% endif %}
        </form>
      </div>

      <div class="d-flex flex-wrap gap-3 justify-content-center mb-4">
        <div class="card shadow-sm border-success kpi-card px-3"><div class="card-body py-2"><h5 class="text-success">{{ total_active }}</h5><small>Activas</small></div></div>
        <div class="card shadow-sm border-danger kpi-card px-3"><div class="card-body py-2"><h5 class="text-danger">{{ total_cancelled }}</h5><small>Canceladas</small></div></div>
        <div class="card shadow-sm border-primary kpi-card px-3"><div class="card-body py-2"><h5 class="text-primary">{{ total }}</h5><small>Totales</small></div></div>
      </div>

      <div class="grid-toolbar">
        <div id="filterCount" class="filter-status">Sin filtros activos</div>
        <a href="?export=excel" class="btn btn-sm btn-outline-success"><i class="bi bi-file-earmark-excel"></i> Exportar</a>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-responsive mt-3">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-primary text-center align-middle">
          <tr>
            <th>Evento</th><th>Cliente</th><th>Contacto</th>
            <th>Cantidad</th><th>Fecha reserva</th><th>Estado</th>
          </tr>
          <tr class="bg-light text-dark">
            <th><input type="text" class="filter-input" placeholder="Evento"></th>
            <th><input type="text" class="filter-input" placeholder="Cliente"></th>
            <th><input type="text" class="filter-input" placeholder="TelÃ©fono o email"></th>
            <th><input type="number" class="filter-input" placeholder="#" min="1"></th>
            <th><input type="date" class="filter-input"></th>
            <th>
              <select class="filter-input">
                <option value="">Todos</option>
                <option value="Activa">Activa</option>
                <option value="Cancelada">Cancelada</option>
              </select>
            </th>
          </tr>
        </thead>
        <tbody id="bookingTable">
          {% for b in bookings %}
          <tr>
            <td><strong>{{ b.event.title }}</strong><br><small class="text-muted">{{ b.event.start|date:"d/m/Y H:i" }}</small></td>
            <td>{{ b.name }}</td>
            <td><div>{{ b.phone }}</div><small class="text-muted">{{ b.email }}</small></td>
            <td class="text-center fw-semibold">{{ b.quantity }}</td>
            <td class="text-center text-muted">{{ b.created_at|date:"d/m/Y H:i" }}</td>
            <td class="text-center">{% if not b.cancelled %}<span class="badge bg-success">Activa</span>{% else %}<span class="badge bg-danger">Cancelada</span>{% endif %}</td>
          </tr>
          {% empty %}
          <tr><td colspan="6" class="text-center text-muted py-4"><i class="bi bi-inbox display-6 d-block mb-2"></i>No hay reservas registradas.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if bookings.has_other_pages %}
    <nav><ul class="pagination">{% for num in bookings.paginator.page_range %}
      <li class="page-item {% if bookings.number == num %}active{% endif %}"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>{% endfor %}
    </ul></nav>{% endif %}
  </div>

  <!-- ðŸ§° Barra flotante -->
  <div class="floating-tools">
    <button id="btnRefresh" data-title="Actualizar"><i class="bi bi-arrow-clockwise"></i></button>
    <button id="btnTotals" data-title="Totales visibles"><i class="bi bi-person-lines-fill"></i></button>
    <button id="btnCompact" data-title="Vista compacta"><i class="bi bi-grid-3x3-gap"></i></button>
    <button id="btnClear" data-title="Limpiar filtros"><i class="bi bi-funnel"></i></button>
  </div>

  <!-- Popup resumen -->
  <div id="popupSummary"><h6 id="popupTitle"></h6><p class="mb-0 text-secondary" id="popupContent"></p></div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const inputs = document.querySelectorAll(".filter-input");
    const rows = document.querySelectorAll("#bookingTable tr");
    const filterCountLabel = document.getElementById("filterCount");
    const popup = document.getElementById("popupSummary");
    const popupTitle = document.getElementById("popupTitle");
    const popupContent = document.getElementById("popupContent");

    const btnRefresh = document.getElementById("btnRefresh");
    const btnTotals = document.getElementById("btnTotals");
    const btnCompact = document.getElementById("btnCompact");
    const btnClear = document.getElementById("btnClear");

    const colNames = ["Evento","Cliente","Contacto","Cantidad","Fecha","Estado"];
    let debounceTimer;

    const debounce = (callback, delay = 250) => { clearTimeout(debounceTimer); debounceTimer = setTimeout(callback, delay); };

    inputs.forEach((input, i) => {
      const wrapper = document.createElement("div");
      wrapper.classList.add("filter-wrapper");
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);

      const clearBtn = document.createElement("span");
      clearBtn.classList.add("clear-btn");
      clearBtn.innerHTML = "&#10006;";
      wrapper.appendChild(clearBtn);

      clearBtn.addEventListener("click", () => { input.value=""; clearBtn.style.display="none"; input.classList.remove("active-filter"); applyFilters(); });
      input.addEventListener("input", () => { clearBtn.style.display=input.value?"inline":"none"; input.classList.toggle("active-filter",!!input.value); debounce(() => applyFilters(),200); });
    });

    function applyFilters() {
      const filterValues = Array.from(inputs).map(i => i.value.toLowerCase());
      let activeFilters = filterValues.filter(v => v).length;
      let activeList = [];

      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        let visible = true;
        cells.forEach((cell, i) => {
          if (!filterValues[i]) return;
          const val = filterValues[i];
          const text = cell.textContent.toLowerCase();
          if (!text.includes(val)) visible = false;
        });
        row.style.display = visible ? "" : "none";
      });

      filterValues.forEach((v,i)=>{ if(v) activeList.push(`${colNames[i]}: ${inputs[i].value}`); });
      filterCountLabel.innerHTML = activeFilters
        ? `<strong>${activeFilters}</strong> filtro${activeFilters>1?"s":""} activo${activeFilters>1?"s":""} (${activeList.join(", ")})`
        : "Sin filtros activos";
    }

    btnRefresh.onclick = ()=>location.reload();
    btnClear.onclick = ()=>{ inputs.forEach(i=>{i.value=""; i.classList.remove("active-filter");}); applyFilters(); };

    btnTotals.onclick = ()=>{
      const visibleRows = [...rows].filter(r => r.style.display !== "none" && r.querySelector("td"));
      const totalQty = visibleRows.reduce((sum, r) => {
        const val = parseInt(r.children[3]?.textContent);
        return sum + (isNaN(val) ? 0 : val);
      }, 0);
      const totalVisible = visibleRows.length;

      let statusClass="success";
      if(totalVisible===0) statusClass="warning";
      if(totalQty<0) statusClass="error";

      popup.className = statusClass;
      popupTitle.textContent = (statusClass==="warning")?"Sin resultados":"Resumen de totales";
      popupContent.textContent = `${totalVisible} reservas visibles Â· ${totalQty} asistentes totales`;
      popup.style.display="block";
      setTimeout(()=>popup.style.display="none",4000);
      popup.onclick=()=>popup.style.display="none";
    };

    btnCompact.onclick = ()=>{ document.querySelector("table").classList.toggle("table-sm"); };
  });
  </script>
</body>
</html>
