{% load extra_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Tablero diario de citas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --brand: #005098;
      --bg-soft: #f8f9fa;
      --status-pending: #fd7e14;
      --status-confirmed: #28a745;
      --status-cancelled: #dc3545;
      --status-done: #17a2b8;
    }

    body {
      background: var(--bg-soft);
      font-size: 0.95rem;
      overflow-x: hidden;
    }

    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 1040;
      background: var(--bg-soft);
      padding: 1rem 0 0.75rem;
      border-bottom: 1px solid #dee2e6;
    }

    .sticky-header .title-zone h2 {
      font-weight: 600;
      color: var(--brand);
      margin-bottom: 0.25rem;
    }

    .sticky-header .subtitle {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .search-bar {
      max-width: 420px;
      margin-top: 0.75rem;
    }

    /* ---------- Staff Cards ---------- */
    .staff-block {
      border: none;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      animation: fadeInUp 0.4s ease forwards;
    }

    .card-header {
      background: var(--brand);
      color: #fff;
      font-weight: 600;
      padding: 0.75rem 1rem;
      cursor: pointer;
    }

    .list-group-item {
      border: none;
      border-bottom: 1px solid #eee;
      transition: background 0.2s ease;
    }
    .list-group-item:last-child { border-bottom: none; }

    .apt-click:hover { background: #e9f3ff; }

    .status-badge {
      padding: 0.4em 0.7em;
      border-radius: 12px;
      font-size: 0.8em;
      color: #fff;
      text-transform: capitalize;
    }
    .status-pending { background: var(--status-pending); }
    .status-confirmed { background: var(--status-confirmed); }
    .status-cancelled { background: var(--status-cancelled); }
    .status-done { background: var(--status-done); }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .35rem;
    }
    .action-buttons .btn {
      min-width: 36px;
      height: 30px;
      padding: 0 .5rem;
      border-radius: 8px;
    }
    .action-buttons .btn i { font-size: 1rem; line-height: 1; }
    .action-buttons .btn.disabled { pointer-events: none; opacity: .45; }

    /* ---------- Panel lateral deslizable ---------- */
    .side-panel {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      right: 0;
      background: #fff;
      box-shadow: -4px 0 12px rgba(0,0,0,0.1);
      border-left: 4px solid var(--brand);
      width: 220px;
      z-index: 1080;
      border-radius: 8px 0 0 8px;
      transition: right 0.4s ease;
    }

    .side-panel.hidden {
      right: -180px;
    }

    .panel-tab {
      position: absolute;
      top: 40%;
      left: -34px;
      background: var(--brand);
      color: #fff;
      padding: 0.5rem 0.6rem;
      border-radius: 8px 0 0 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .panel-tab:hover {
      background: #013f77;
    }

    .side-panel-header {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--brand);
      margin-bottom: 0.75rem;
    }

    .side-panel ul {
      list-style: none;
      padding-left: 0;
      margin-bottom: 0;
      font-size: 0.9rem;
    }

    .side-panel li {
      margin-bottom: 0.35rem;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body class="p-3 p-md-4">
  <div class="container">

    <!-- Encabezado Sticky -->
    <div class="sticky-header mb-4">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div class="title-zone">
          {% with the_day=day|default:today %}
          <h2>
            {% if the_day == today %}Hoy — {% endif %}
            {{ the_day|date:"l, j \\d\\e F \\d\\e Y" }}
          </h2>
          {% if citas %}
          <div class="subtitle">
            Semana {{ the_day|date:"W" }} • {{ citas|length }} cita{% if citas|length != 1 %}s{% endif %}
          </div>
          {% endif %}
          {% endwith %}
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <a href="/" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Volver
          </a>
          <a class="btn btn-success btn-sm"
             href="{% url 'bookings:create_appointment' %}?date={{ day|date:'Y-m-d' }}T09:00">
            <i class="bi bi-calendar-plus"></i> Agendar cita
          </a>
        </div>
      </div>

      <div class="search-bar input-group mt-3">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input id="agendaSearch" type="search" class="form-control" placeholder="Buscar por cliente, notas u hora…">
        <button id="agendaClear" class="btn btn-outline-secondary" type="button">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    </div>

    <!-- Listado por Staff -->
    {% for s in staff_list %}
    <section class="card mb-4 staff-block">
      <header class="card-header d-flex justify-content-between align-items-center"
              data-bs-toggle="collapse" data-bs-target="#staff-{{ s.id }}" aria-expanded="true">
        <span>{{ s.role }} — {{ s.name }}</span>
        {% if staff_counters %}
          {% with c=staff_counters|get_item:s.id %}
          <span class="badge bg-light text-dark">{{ c.done }} / {{ c.total }}</span>
          {% endwith %}
        {% endif %}
      </header>

      <div id="staff-{{ s.id }}" class="collapse show">
        <div class="list-group list-group-flush">
          {% for a in s.appointment_set.all %}
          <article class="list-group-item d-flex justify-content-between align-items-center appointment-item"
                   data-search="{{ a.start|date:'H:i' }} {{ a.client.name }} {{ a.notes|default:'Sin notas' }}">
            <div class="apt-click flex-grow-1 me-3" role="button"
                 data-href="{% url 'bookings:edit_appointment' a.pk %}?next={{ request.get_full_path|urlencode }}">
              <strong>{{ a.start|date:"H:i" }}</strong> — {{ a.client.name }}
              <small class="text-muted d-block">{{ a.notes|default:"Sin notas" }}</small>
            </div>

            <div class="d-flex align-items-center">
              <span id="status-{{ a.pk }}" class="status-badge
                {% if a.status == 'pending' %}status-pending{% elif a.status == 'confirmed' %}status-confirmed
                {% elif a.status == 'cancelled' %}status-cancelled{% elif a.status == 'done' %}status-done{% endif %}">
                {{ a.get_status_display }}
              </span>

              <div class="btn-group btn-group-sm ms-2 action-buttons">
                <a href="{% url 'bookings:change_appointment_status' a.pk 'confirmed' %}"
                   class="btn btn-outline-success btn-icon ajax-status {% if a.status == 'confirmed' %}disabled{% endif %}"
                   data-id="{{ a.pk }}" data-status="confirmed" title="Confirmar">
                  <i class="bi bi-check2-circle"></i>
                </a>
                <a href="{% url 'bookings:change_appointment_status' a.pk 'cancelled' %}"
                   class="btn btn-outline-danger btn-icon ajax-status {% if a.status == 'cancelled' %}disabled{% endif %}"
                   data-id="{{ a.pk }}" data-status="cancelled" title="Cancelar">
                  <i class="bi bi-x-circle"></i>
                </a>
                <a href="{% url 'bookings:change_appointment_status' a.pk 'done' %}"
                   class="btn btn-outline-info btn-icon ajax-status {% if a.status == 'done' %}disabled{% endif %}"
                   data-id="{{ a.pk }}" data-status="done" title="Atendida">
                  <i class="bi bi-stop-circle"></i>
                </a>
                <a href="{% url 'bookings:change_appointment_status' a.pk 'pending' %}"
                   class="btn btn-outline-secondary btn-icon ajax-status {% if a.status == 'pending' %}disabled{% endif %}"
                   data-id="{{ a.pk }}" data-status="pending" title="Volver a pendiente">
                  <i class="bi bi-arrow-counterclockwise"></i>
                </a>
              </div>
            </div>
          </article>
          {% empty %}
          <div class="list-group-item text-muted">Sin citas.</div>
          {% endfor %}
        </div>
      </div>
    </section>
    {% empty %}
    <p class="alert alert-warning">No hay staff registrado.</p>
    {% endfor %}

    
  <div class="btn-group mb-3">
    <a href="{% url 'bookings:person_form' %}?type=client" class="btn btn-outline-success btn-sm">
      <i class="bi bi-person-plus"></i> Nuevo cliente
    </a>
    <a href="{% url 'bookings:person_form' %}?type=staff" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-person-badge"></i> Nuevo staff
    </a>
  </div>
  
  </div>

  <!-- Toast -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000">
    <div id="liveToast" class="toast text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div id="toast-body" class="toast-body">Operación realizada</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Panel lateral deslizable -->
  <aside id="panel-deslizable" class="side-panel hidden">
    <div class="panel-tab"><i class="bi bi-chevron-left"></i></div>
    <div class="p-3">
      <div class="side-panel-header"><i class="bi bi-bar-chart"></i> Resumen del día</div>
      <ul id="statsList">
        <li><i class="bi bi-hourglass-split text-warning me-1"></i> Pendientes: <span id="count-pending">{{ stats.pending }}</span></li>
        <li><i class="bi bi-check-circle text-success me-1"></i> Confirmadas: <span id="count-confirmed">{{ stats.confirmed }}</span></li>
        <li><i class="bi bi-x-circle text-danger me-1"></i> Canceladas: <span id="count-cancelled">{{ stats.cancelled }}</span></li>
        <li><i class="bi bi-hand-thumbs-up text-info me-1"></i> Atendidas: <span id="count-done">{{ stats.done }}</span></li>
      </ul>
    </div>
  </aside>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (() => {
      const csrftoken = document.cookie.split('; ')
        .find(row => row.startsWith('csrftoken='))?.split('=')[1];
      const toastEl = document.getElementById('liveToast');
      const toastBody = document.getElementById('toast-body');
      const toast = toastEl ? new bootstrap.Toast(toastEl, { delay: 2200 }) : null;
      const showToast = (msg, variant = 'success') => {
        toastEl.className = `toast text-bg-${variant} border-0 align-items-center`;
        toastBody.textContent = msg;
        toast?.show();
      };

      const counters = {
        pending: document.getElementById('count-pending'),
        confirmed: document.getElementById('count-confirmed'),
        cancelled: document.getElementById('count-cancelled'),
        done: document.getElementById('count-done')
      };

      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.ajax-status');
        if (!btn || btn.classList.contains('disabled')) return;
        e.preventDefault();

        const url = btn.getAttribute('href');
        const id = btn.dataset.id;
        const newStatus = btn.dataset.status;
        const badge = document.getElementById(`status-${id}`);

        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
          });
          if (!res.ok) { showToast('Error al actualizar el estado.', 'danger'); return; }

          const labels = { pending: 'Pendiente', confirmed: 'Confirmada', cancelled: 'Cancelada', done: 'Atendida' };
          badge.textContent = labels[newStatus] || newStatus;
          badge.className = `status-badge status-${newStatus}`;
          btn.closest('.action-buttons').querySelectorAll('.ajax-status')
            .forEach(b => b.classList.remove('disabled'));
          btn.classList.add('disabled');

          // 🧮 Actualiza conteos visuales
          Object.keys(counters).forEach(k => {
            let val = parseInt(counters[k].textContent || 0);
            if (badge.classList.contains(`status-${k}`)) counters[k].textContent = Math.max(val - 1, 0);
          });
          counters[newStatus].textContent = parseInt(counters[newStatus].textContent || 0) + 1;

          showToast(`Estado actualizado a ${labels[newStatus]}`, 'success');
        } catch (err) {
          console.error(err);
          showToast('Error de red al actualizar.', 'danger');
        }
      });
    })();

    // ========== PANEL DESLIZABLE CON PERSISTENCIA ==========
    (() => {
      const panel = document.getElementById('panel-deslizable');
      const tab = panel.querySelector('.panel-tab');
      const STORAGE_KEY = 'panel_deslizable_abierto';

      const isOpen = localStorage.getItem(STORAGE_KEY) === 'true';
      if (isOpen) panel.classList.remove('hidden');

      tab.addEventListener('mouseenter', () => panel.classList.remove('hidden'));
      panel.addEventListener('mouseleave', () => {
        panel.classList.add('hidden');
        localStorage.setItem(STORAGE_KEY, 'false');
      });
      tab.addEventListener('click', () => {
        const wasHidden = panel.classList.toggle('hidden');
        localStorage.setItem(STORAGE_KEY, !wasHidden);
      });
    })();
  </script>
</body>
</html>
