{% load static %}
<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>Eventos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --brand: #0d6efd;
      --bg: #f6f7f8;
      --line: #343a40;
      --hover: #e7f1ff;
      --active: #d7e7ff;
    }

    body {
      background: var(--bg);
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .06);
    }

    .card-hover:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, .12);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .25rem .55rem;
      border-radius: 999px;
      font-size: .82rem;
      border: 1px solid rgba(0, 0, 0, .08)
    }

    .chip i {
      font-size: .95rem
    }

    .chip-cap {
      background: #fff;
    }

    .chip-ok {
      background: #e7f1ff;
      color: #084298;
      border-color: #cfe2ff;
    }

    .chip-low {
      background: #fff3cd;
      color: #664d03;
      border-color: #ffe69c;
    }

    .chip-none {
      background: #f8d7da;
      color: #842029;
      border-color: #f5c2c7;
    }

    .btn-reserve.disabled,
    .btn-reserve[disabled] {
      pointer-events: none;
      opacity: .65;
    }

    .card-title a {
      color: inherit;
      text-decoration: none;
    }

    .stretched-link {
      position: relative;
      z-index: 0;
    }

    /* Header sticky (botón + título siempre visibles) */
    .page-header {
      position: sticky;
      top: 0;
      z-index: 1010;
      background: var(--bg);
      border-bottom: 1px solid #e5e7eb;
      padding: .5rem 0;
      margin-bottom: 1rem;
    }

    .btn-back {
      padding: .3rem .6rem;
    }

    /* Timeline lateral (scroll interno + separación por año) */
    .timeline {
      position: sticky;
      top: 1rem;
      padding-left: 1rem;
      border-left: 3px solid var(--line);
      max-height: calc(100vh - 2rem);
      overflow-y: auto;
    }

    .timeline-year {
      margin-bottom: .75rem;
    }

    .timeline .year-label {
      margin-left: .5rem;
      margin-bottom: .25rem;
      font-weight: 800;
      font-size: .95rem;
      color: var(--brand);
      text-transform: uppercase;
      letter-spacing: .02em;
    }

    .timeline .month-link {
      display: block;
      margin: .25rem 0 .25rem -1px;
      padding: .35rem .5rem .35rem .75rem;
      color: #212529;
      text-decoration: none;
      position: relative;
      line-height: 1.2;
      border-radius: 8px;
      transition: background .18s ease, font-weight .18s ease, color .18s ease;
    }

    .timeline .month-link::before {
      content: "";
      position: absolute;
      left: -11px;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--line);
      transition: transform .18s ease, background .18s ease;
    }

    .timeline .month-link:hover {
      background: var(--hover);
      font-weight: 600;
    }

    .timeline .month-link.active {
      background: var(--active);
      color: var(--brand);
      font-weight: 700;
    }

    .timeline .month-link.active::before {
      transform: translateY(-50%) scale(1.3);
      background: var(--brand);
    }

    /* Encabezado de mes en el grid de tarjetas (full row) */
    .month-anchor {
      scroll-margin-top: 84px;
      /* espacio al anclar con header sticky */
      position: relative;
      margin: 14px 0 8px;
      padding-top: 10px;
      border-top: 2px solid #e5e7eb;
    }

    .month-anchor::after {
      content: attr(data-month-name);
      position: absolute;
      top: -12px;
      left: 8px;
      background: var(--bg);
      padding: 0 .5rem;
      font-weight: 700;
      color: #111827;
      border-radius: 6px;
    }
  </style>
</head>

<body class="p-4">
  <div class="container" style="max-width: 1100px;">

    <!-- Header sticky: botones y título -->
    <div class="page-header d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">

      <!-- Botón Volver (izquierda) -->
      <div class="mb-2 mb-md-0">
        <a href="/" class="btn btn-outline-secondary btn-back">
          <i class="bi bi-arrow-left"></i> Volver
        </a>
      </div>

      <!-- Botón Panel (derecha) - solo para staff -->
      {% if user.is_authenticated and user.is_staff %}
      <div class="mb-2 mb-md-0">
        <a href="{% url 'admin_panel:dashboard' %}" class="btn btn-outline-primary">
          <i class="bi bi-speedometer2"></i> Ir al panel
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Título principal -->
    <h1 class="text-center text-md-start fw-bold mb-4">Eventos</h1>


    <div class="row">
      <!-- Columna izquierda: Timeline -->
      <aside class="col-lg-3 d-none d-lg-block">
        <nav id="timeline" class="timeline" aria-label="Línea de tiempo por meses">
          <!-- Se llena por JS -->
        </nav>
      </aside>

      <!-- Columna derecha: tarjetas -->
      <section class="col-lg-9">
        <div class="row gy-3">
          {% for e in events %}
          {% url 'bookings:event_detail' e.pk as event_url %}
          {% with absolute_url=request.scheme|add:"://"|add:request.get_host|add:event_url %}

          {# ==== ANCLA ÚNICA POR MES: fuerza salto a nueva línea con col-12 ==== #}
          {% ifchanged e.start|date:'Y-m' %}
          <div class="col-12">
            <div id="m-{{ e.start|date:'Y-m' }}" class="month-anchor"
              data-month-name="{{ e.start|date:'F Y'|capfirst }}"></div>
          </div>
          {% endifchanged %}

          <div class="col-12 col-md-6 col-lg-4">
            <div class="card card-hover h-100" data-month="{{ e.start|date:'Y-m' }}"
              data-month-name="{{ e.start|date:'F Y'|capfirst }}">
              <div class="card-body d-flex flex-column">

                <!-- Título + inicio (formato legible en ES) -->
                <h5 class="card-title mb-1">
                  <a href="{{ event_url }}" class="stretched-link">{{ e.title }}</a>
                </h5>
                <div class="text-muted mb-2">
                  <i class="bi bi-calendar2-week me-1"></i>
                  <strong>Inicio:</strong>
                  {{ e.start|date:"l, d \\de F \\a las H:i" | capfirst }}
                </div>

                <!-- Descripción -->
                <p class="card-text mb-3">{{ e.description|default:""|truncatechars:140 }}</p>

                <!-- Chips de aforo -->
                <div class="d-flex gap-2 mb-3">
                  {% if e.seats_available|default:0 <= 0 %} <span class="chip chip-none"
                    title="Sin lugares disponibles">
                    <i class="bi bi-people"></i> Agotado
                    </span>
                    {% elif e.seats_available <= 5 %} <span class="chip chip-low" title="Quedan pocos lugares">
                      <i class="bi bi-people"></i> Disponibles: {{ e.seats_available }}
                      </span>
                      {% else %}
                      <span class="chip chip-ok">
                        <i class="bi bi-people"></i> Disponibles: {{ e.seats_available }}
                      </span>
                      {% endif %}

                      <span class="chip chip-cap">
                        <i class="bi bi-bounding-box-circles"></i> Capacidad: {{ e.capacity }}
                      </span>
                </div>

                <!-- Acciones -->
                <div class="d-flex flex-wrap gap-2 mt-auto">
                  <button type="button" class="btn btn-outline-secondary btn-share" data-url="{{ absolute_url }}"
                    data-title="{{ e.title|escape }}" aria-label="Compartir {{ e.title }}">
                    <i class="bi bi-share"></i> Compartir
                  </button>

                  <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
                    data-bs-target="#qr-{{ e.pk }}" aria-label="Mostrar QR de {{ e.title }}">
                    <i class="bi bi-qr-code"></i> QR
                  </button>

                  {% if e.seats_available|default:0 <= 0 %} <button class="btn btn-primary btn-reserve" disabled
                    data-bs-toggle="tooltip" data-bs-title="Sin lugares disponibles">
                    <i class="bi bi-ticket-perforated"></i> Reservar
                    </button>
                    {% else %}
                    <a href="{{ event_url }}" class="btn btn-primary btn-reserve">
                      <i class="bi bi-ticket-perforated"></i> Reservar
                    </a>
                    {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Modal QR -->
          <div class="modal fade" id="qr-{{ e.pk }}" tabindex="-1" aria-labelledby="qrLabel-{{ e.pk }}"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 id="qrLabel-{{ e.pk }}" class="modal-title">QR — {{ e.title }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                  <img class="img-fluid" alt="Código QR para {{ e.title }}"
                    src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data={{ absolute_url|urlencode }}">
                  <div class="mt-3 d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <a class="btn btn-primary btn-sm" href="{{ absolute_url }}" target="_blank" rel="noopener">
                      <i class="bi bi-box-arrow-up-right"></i> Abrir en navegador
                    </a>
                    <a class="btn btn-outline-secondary btn-sm" href="{{ absolute_url }}" download>
                      <i class="bi bi-download"></i> Abrir/guardar
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% endwith %}
          {% empty %}
          <div class="col-12">
            <div class="alert alert-info mb-0">No hay eventos publicados.</div>
          </div>
          {% endfor %}
        </div>
      </section>
    </div>
  </div>

  <!-- Modal Compartir (fallback) -->
  <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="shareLabel" class="modal-title">Compartir evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">Copia este enlace y compártelo:</div>
          <div class="input-group">
            <input id="shareInput" type="text" class="form-control" value="" readonly>
            <button id="copyBtn" class="btn btn-outline-secondary" type="button">
              <i class="bi bi-clipboard"></i> Copiar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast copiar enlace -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000">
    <div id="copyToast" class="toast text-bg-dark" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Enlace copiado</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Cerrar"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Tooltips (reservar deshabilitado)
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

    // ===== Compartir =====
    const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
    const shareInput = document.getElementById('shareInput');
    const copyToast = new bootstrap.Toast(document.getElementById('copyToast'), { delay: 1800 });

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.btn-share');
      if (!btn) return;

      const url = btn.dataset.url;
      const title = btn.dataset.title || document.title;

      if (navigator.share) {
        try {
          await navigator.share({ title, url });
          return; // compartido con éxito
        } catch {
          // usuario canceló → mostramos fallback modal igualmente
        }
      }
      // Fallback modal
      shareInput.value = url;
      shareModal.show();
      shareInput.focus();
      shareInput.select();
    });

    document.getElementById('copyBtn')?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(shareInput.value);
        copyToast.show();
      } catch {
        shareInput.select();
        document.execCommand('copy');
        copyToast.show();
      }
    });

    // ===== Timeline por meses (agrupado por año, con scroll interno) =====
    (function buildTimeline() {
      const tl = document.getElementById('timeline');
      if (!tl) return;

      // Tomamos los anchors únicos por mes (generados con col-12)
      const anchors = Array.from(document.querySelectorAll('.month-anchor')); // id="m-YYYY-MM"
      if (!anchors.length) return;

      // Construye estructura por años
      const months = anchors.map(an => {
        const key = an.id.replace('m-', '');            // YYYY-MM
        const label = an.getAttribute('data-month-name') || key; // "Octubre 2025"
        const parts = key.split('-');
        return { key, label, year: parts[0] };
      }).sort((a, b) => a.key.localeCompare(b.key));

      const byYear = months.reduce((acc, m) => {
        (acc[m.year] ||= []).push(m);
        return acc;
      }, {});

      // Render timeline
      tl.innerHTML = Object.keys(byYear).sort().map(year => {
        const links = byYear[year].map(m => `
          <a class="month-link" href="#m-${m.key}" data-key="${m.key}">
            ${m.label}
          </a>
        `).join('');
        return `
          <div class="timeline-year" data-year="${year}">
            <div class="year-label">${year}</div>
            ${links}
          </div>
        `;
      }).join('');

      const links = Array.from(tl.querySelectorAll('.month-link'));

      // Calcula el mes activo usando un umbral cerca del header sticky
      const computeActive = () => {
        const mid = window.innerHeight * 0.35; // “zona dulce”
        let bestIdx = 0;
        let bestDist = Infinity;

        anchors.forEach((an, i) => {
          const top = an.getBoundingClientRect().top;
          const dist = Math.abs(top - mid);
          if (dist < bestDist) { bestDist = dist; bestIdx = i; }
        });

        links.forEach(l => l.classList.remove('active'));
        const activeKey = anchors[bestIdx].id.replace('m-', '');
        const activeLink = tl.querySelector(`.month-link[data-key="${activeKey}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
          // Auto-scroll del timeline para mantener visible el activo
          const parent = tl;
          const lTop = activeLink.offsetTop - parent.scrollTop;
          if (lTop < 0 || lTop > parent.clientHeight - 40) {
            parent.scrollTo({ top: activeLink.offsetTop - 20, behavior: 'smooth' });
          }
        }
      };

      // Marca activo al cargar y al hacer scroll
      document.addEventListener('scroll', computeActive, { passive: true });
      computeActive();

      // Feedback inmediato al hacer click
      tl.addEventListener('click', (e) => {
        const a = e.target.closest('.month-link');
        if (!a) return;
        links.forEach(l => l.classList.remove('active'));
        a.classList.add('active');
      });
    })();
  </script>
</body>

</html>